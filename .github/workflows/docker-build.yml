name: Build and Push Docker Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'vla/**'
      - '.github/workflows/docker-build.yml'

env:
  IMAGE_NAME: noppdev/crane_x7_vla
  ACR_REGISTRY: noppdev.azurecr.io
  ACR_NAME: noppdev

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Generate tags
        id: tags
        run: |
          TAGS=""
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # タグプッシュの場合
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
            TAGS="$VERSION"
            # major.minor タグも追加
            MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
            TAGS="$TAGS $MAJOR_MINOR"
          fi

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # mainブランチの場合
            TAGS="$TAGS latest"
          fi

          # SHA タグは常に追加
          TAGS="$TAGS sha-$SHA_SHORT"

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Generated tags: $TAGS"

      - name: Build with Azure ACR
        run: |
          # ACRでビルド（最初のタグを使用）
          FIRST_TAG=$(echo "${{ steps.tags.outputs.tags }}" | awk '{print $1}')
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.IMAGE_NAME }}:$FIRST_TAG \
            --file vla/Dockerfile \
            vla/

      - name: Tag additional images in ACR
        run: |
          TAGS="${{ steps.tags.outputs.tags }}"
          FIRST_TAG=$(echo "$TAGS" | awk '{print $1}')

          for TAG in $TAGS; do
            if [ "$TAG" != "$FIRST_TAG" ]; then
              echo "Tagging $TAG..."
              az acr import \
                --name ${{ env.ACR_NAME }} \
                --source ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:$FIRST_TAG \
                --image ${{ env.IMAGE_NAME }}:$TAG \
                --force
            fi
          done

      - name: Install crane
        run: |
          VERSION=$(curl -s "https://api.github.com/repos/google/go-containerregistry/releases/latest" | jq -r '.tag_name')
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar -xzf - crane
          chmod +x crane
          sudo mv crane /usr/local/bin/

      - name: Login to registries for crane
        run: |
          # ACR login
          ACR_TOKEN=$(az acr login --name ${{ env.ACR_NAME }} --expose-token --output tsv --query accessToken)
          echo "$ACR_TOKEN" | crane auth login ${{ env.ACR_REGISTRY }} -u 00000000-0000-0000-0000-000000000000 --password-stdin

          # Docker Hub login
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | crane auth login docker.io -u ${{ vars.DOCKERHUB_USERNAME }} --password-stdin

      - name: Copy images to Docker Hub
        run: |
          TAGS="${{ steps.tags.outputs.tags }}"

          for TAG in $TAGS; do
            echo "Copying $TAG to Docker Hub..."
            crane copy \
              ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG \
              docker.io/${{ env.IMAGE_NAME }}:$TAG
          done

          echo "✅ All images pushed to Docker Hub"
