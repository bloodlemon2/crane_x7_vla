# Pi0 Configuration for CRANE-X7
# Uses PaliGemma + Expert Gemma architecture with flow matching
#
# Pi0 vs Pi0.5:
# - Pi0: Continuous state input, MLP for timestep processing
# - Pi0.5: Discrete state tokens, adaRMSNorm for timestep injection

# Base settings
backend: pi0
experiment_name: crane_x7_pi0

# Data configuration
data:
  data_root: /workspace/data/tfrecord_logs
  format: tfrecord

# Training configuration
training:
  batch_size: 8
  max_steps: 100000
  learning_rate: 1.0e-5
  weight_decay: 0.01
  warmup_steps: 1000
  max_grad_norm: 1.0
  gradient_accumulation_steps: 4
  gradient_checkpointing: true
  save_interval: 5000
  log_interval: 10

# Overfitting detection
overfitting:
  overfit_split_ratio: 0.1
  overfit_check_interval: 500
  overfit_check_steps: 50

# W&B logging
wandb_project: crane-x7-pi0
wandb_entity: null

# Pi0-specific configuration
pi0:
  # Model type: 'pi0' or 'pi0.5'
  model_type: pi0

  # Model architecture
  paligemma_variant: gemma_2b  # VLM backbone (gemma_2b, gemma_2b_lora)
  action_expert_variant: gemma_300m  # Action expert (gemma_300m, gemma_300m_lora)
  pretrained_checkpoint: null  # Path to pretrained checkpoint

  # Action configuration
  action_dim: 32  # Pi0 action dimension (padded from CRANE-X7's 8)
  state_dim: 32
  action_horizon: 50  # Number of future actions to predict

  # Token configuration
  max_token_len: 48  # Max language token length (48 for Pi0, 200 for Pi0.5)
  discrete_state_input: false  # Use discrete state (auto-set for Pi0.5)

  # Image configuration
  image_size:
    - 224
    - 224
  num_cameras: 1
  camera_names:
    - base_0_rgb
    # - left_wrist_0_rgb
    # - right_wrist_0_rgb

  # Flow matching
  num_denoise_steps: 5

  # Normalization
  normalize_actions: true
  normalization_mode: quantile  # 'quantile' or 'zscore'
  quantile_low: 0.01
  quantile_high: 0.99

  # LoRA (optional)
  use_lora: false
  lora_rank: 32
  lora_alpha: 16
  lora_dropout: 0.1

  # Freeze settings
  freeze_vlm: true  # Freeze PaliGemma weights (recommended)
  freeze_action_expert: false

  # Precision
  precision: bfloat16

  # Default prompt
  default_prompt: "manipulate objects"

  # Delta actions
  use_delta_actions: false
