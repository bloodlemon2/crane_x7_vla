# ============================================================================
# CRANE-X7 VLA Docker Compose
# ============================================================================
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 nop
#
# Unified Docker Compose configuration for ROS 2 and VLA-RL environments.
#
# Usage:
#   docker compose --profile <profile> up
#
# ============================================================================

# ============================================================================
# Common Configuration Anchors
# ============================================================================

# Build configuration for ROS 2
x-build-ros2: &build-ros2
  context: .
  dockerfile: docker/Dockerfile.ros2

# Build configuration for VLA-RL
x-build-vla-rl: &build-vla-rl
  context: .
  dockerfile: docker/Dockerfile.vla-rl

# Build configuration for Remote Inference
x-build-inference: &build-inference
  context: .
  dockerfile: docker/Dockerfile.remote-inference

# Build configuration for LeRobot
x-build-lerobot: &build-lerobot
  context: .
  dockerfile: docker/Dockerfile.lerobot

# Volume configurations
x-x11-volumes: &x11-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ./ros2/src:/workspace/ros2/src:ro
  - ./data:/workspace/data:rw
  - /run/user/1000/pulse:/run/user/1000/pulse:ro

x-vla-volumes: &vla-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ./vla/src:/workspace/vla/src:ro
  - ./vla/outputs:/workspace/vla/outputs:ro
  - ./data:/workspace/data:ro
  - ./ros2/src:/workspace/ros2/src:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-ros2}/.cache/huggingface:rw
  - ${HOME}/.cache/crane_x7_vla:/home/${USERNAME:-ros2}/.cache/crane_x7_vla:rw

x-lift-volumes: &lift-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ./sim/src:/workspace/sim/src:ro
  - ./vla/src:/workspace/vla/src:ro
  - ./vla/outputs:/workspace/vla/outputs:ro
  - ./data:/workspace/data:rw
  - ./ros2/src:/workspace/ros2/src:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-ros2}/.cache/huggingface:rw
  - ${HOME}/.cache/crane_x7_vla:/home/${USERNAME:-ros2}/.cache/crane_x7_vla:rw

x-vla-rl-volumes: &vla-rl-volumes
  - ./vla-rl:/workspace/vla-rl:rw
  - ./sim:/workspace/sim:ro
  - ./vla/outputs:/workspace/vla/outputs:ro
  - ./data:/workspace/data:rw
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/root/.cache/huggingface:rw
  - ${HOME}/.cache/crane_x7_vla:/root/.cache/crane_x7_vla:rw

x-inference-volumes: &inference-volumes
  - ./vla/outputs:/workspace/models:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/root/.cache/huggingface:rw
  - ${HOME}/.cache/crane_x7_vla:/root/.cache/crane_x7_vla:rw
  - tailscale-state:/var/lib/tailscale

x-lerobot-volumes: &lerobot-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ./lerobot:/workspace/lerobot:rw
  - ./data:/workspace/data:rw
  - /run/user/1000/pulse:/run/user/1000/pulse:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-lerobot}/.cache/huggingface:rw

# Environment configurations
x-base-env: &base-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  CUDA_VISIBLE_DEVICES: ""

x-vla-env: &vla-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  HF_TOKEN: ${HF_TOKEN:-}
  HF_HOME: /home/${USERNAME:-ros2}/.cache/huggingface
  VLA_TASK_INSTRUCTION: ${VLA_TASK_INSTRUCTION}
  VLA_DEVICE: ${VLA_DEVICE:-cuda}

x-lift-env: &lift-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
  LIFT_BACKEND: ${LIFT_BACKEND:-cpu}
  LIFT_RENDER_MODE: ${LIFT_RENDER_MODE:-none}

x-vla-rl-env: &vla-rl-env
  LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
  LIFT_BACKEND: ${LIFT_BACKEND:-gpu}
  WANDB_API_KEY: ${WANDB_API_KEY:-}
  HF_TOKEN: ${HF_TOKEN:-}
  # EGL for headless GPU rendering (Genesis)
  PYOPENGL_PLATFORM: egl

x-inference-env: &inference-env
  TS_AUTHKEY: ${TS_AUTHKEY:-}
  TS_HOSTNAME: ${TS_HOSTNAME:-crane-x7-inference}
  TS_USERSPACE: "true"
  ROSBRIDGE_HOST: ${ROSBRIDGE_HOST:-crane-x7-local}
  ROSBRIDGE_PORT: ${ROSBRIDGE_PORT:-9090}
  VLA_MODEL_PATH: ${VLA_MODEL_PATH}
  VLA_TASK_INSTRUCTION: ${VLA_TASK_INSTRUCTION}
  VLA_DEVICE: ${VLA_DEVICE:-cuda}
  VLA_INFERENCE_RATE: ${VLA_INFERENCE_RATE:-10.0}
  HF_TOKEN: ${HF_TOKEN:-}

x-lerobot-env: &lerobot-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  HF_TOKEN: ${HF_TOKEN:-}
  HF_HOME: /home/${USERNAME:-lerobot}/.cache/huggingface
  WANDB_API_KEY: ${WANDB_API_KEY:-}

# Group configurations
x-real-groups: &real-groups
  - dialout
  - audio
  - "984"  # video group GID on Arch Linux
  - "985"  # uucp group GID on Arch Linux

# Base service configuration for ROS 2
x-base: &base
  env_file: .env
  build:
    <<: *build-ros2
  devices:
    - "/dev/snd:/dev/snd"
  volumes: *x11-volumes
  group_add:
    - audio
  environment:
    <<: *base-env

# GPU deployment configuration
x-gpu-deploy: &gpu-deploy
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: 1
          capabilities: [gpu]

# ============================================================================
# Services
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Real Robot Services
  # --------------------------------------------------------------------------
  real:
    <<: *base
    profiles: [real]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
      - "/dev/bus/usb:/dev/bus/usb"
    privileged: true
    group_add: *real-groups
    command: ros2 launch crane_x7_bringup real.launch.py use_d435:=${USE_D435:-false} use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Simulation Services
  # --------------------------------------------------------------------------
  sim:
    <<: *base
    profiles: [sim]
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_bringup sim.launch.py use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Teleoperation Services
  # --------------------------------------------------------------------------
  teleop-leader:
    <<: *base
    profiles: [teleop, log]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_leader.launch.py

  teleop-follower:
    <<: *base
    profiles: [teleop, log]
    devices:
      - "${USB_DEVICE_FOLLOWER:-/dev/ttyUSB1}:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_follower.launch.py

  teleop-logger:
    <<: *base
    profiles: [log]
    privileged: true
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ./ros2/src:/workspace/ros2/src:ro
      - ./data:/workspace/data:rw
      - /run/user/1000/pulse:/run/user/1000/pulse:ro
      - /dev:/dev:ro
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command:
      - /bin/bash
      - -c
      - |
        CAMERA_ARGS="camera_serial:='${CAMERA_SERIAL:-}'"
        if [ -n "${CAMERA2_SERIAL:-}" ]; then
          CAMERA_ARGS="$$CAMERA_ARGS camera2_serial:='${CAMERA2_SERIAL}'"
        fi
        ros2 launch crane_x7_bringup data_collection.launch.py \
          use_viewer:=${USE_VIEWER:-true} \
          $$CAMERA_ARGS

  # --------------------------------------------------------------------------
  # VLA Inference Services
  # --------------------------------------------------------------------------
  vla-real:
    <<: *base
    profiles: [vla]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
      - "/dev/bus/usb:/dev/bus/usb"
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ./ros2/src:/workspace/ros2/src:ro
      - ./data:/workspace/data:rw
      - ./vla/outputs:/workspace/vla/outputs:ro
      - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-ros2}/.cache/huggingface:rw
      - ${HOME}/.cache/crane_x7_vla:/home/${USERNAME:-ros2}/.cache/crane_x7_vla:rw
      - /run/user/1000/pulse:/run/user/1000/pulse:ro
    privileged: true
    group_add: *real-groups
    environment:
      <<: *vla-env
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup vla_real.launch.py
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'
        use_d435:=true

  vla-sim:
    <<: *base
    profiles: [vla-sim]
    volumes: *vla-volumes
    environment:
      <<: *vla-env
      SIMULATION_MODE: "true"
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup vla_sim.launch.py
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'

  # --------------------------------------------------------------------------
  # Lift Simulation Services (unified simulator abstraction)
  # --------------------------------------------------------------------------
  lift:
    <<: *base
    profiles: [lift]
    volumes: *lift-volumes
    environment:
      <<: *lift-env
    command: >
      ros2 launch crane_x7_bringup lift.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        backend:='${LIFT_BACKEND:-cpu}'
        render_mode:='${LIFT_RENDER_MODE:-none}'

  lift-vla:
    <<: *base
    profiles: [lift-vla]
    volumes: *lift-volumes
    environment:
      <<: *vla-env
      LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup lift_vla.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'

  lift-logger:
    <<: *base
    profiles: [lift-logger]
    volumes: *lift-volumes
    environment:
      <<: *lift-env
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup lift_logger.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        backend:='${LIFT_BACKEND:-gpu}'

  # --------------------------------------------------------------------------
  # VLA-RL Training Services
  # --------------------------------------------------------------------------
  vla-rl:
    profiles: [vla-rl]
    build:
      <<: *build-vla-rl
      target: base
    volumes: *vla-rl-volumes
    environment:
      <<: *vla-rl-env
    deploy:
      <<: *gpu-deploy
    working_dir: /workspace/vla-rl
    command: >
      python -m crane_x7_vla_rl.training.cli train
        --simulator ${LIFT_SIMULATOR:-maniskill}
        --env-id PickPlace-CRANE-X7
        --backend ${LIFT_BACKEND:-gpu}
        --num-parallel-envs ${VLA_RL_NUM_ENVS:-4}
        --use-wandb

  vla-rl-dev:
    profiles: [vla-rl-dev]
    build:
      <<: *build-vla-rl
      target: dev
    volumes:
      - ./vla-rl:/workspace/vla-rl:rw
      - ./sim:/workspace/sim:rw
      - ./vla/outputs:/workspace/vla/outputs:ro
      - ./data:/workspace/data:rw
      - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/root/.cache/huggingface:rw
      # X11 for real-time visualization
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
    environment:
      DISPLAY: ${DISPLAY}
      LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
      LIFT_BACKEND: ${LIFT_BACKEND:-cpu}
      WANDB_API_KEY: ${WANDB_API_KEY:-}
      HF_TOKEN: ${HF_TOKEN:-}
      # EGL for headless GPU rendering (Genesis)
      PYOPENGL_PLATFORM: egl
    deploy:
      <<: *gpu-deploy
    working_dir: /workspace/vla-rl
    stdin_open: true
    tty: true
    command: /bin/bash

  # --------------------------------------------------------------------------
  # Rosbridge Services (for remote inference)
  # --------------------------------------------------------------------------
  rosbridge-real:
    <<: *base
    profiles: [rosbridge]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
      - "/dev/bus/usb:/dev/bus/usb"
    privileged: true
    group_add: *real-groups
    command: ros2 launch crane_x7_bringup rosbridge_real.launch.py use_d435:=${USE_D435:-true}

  rosbridge-sim:
    <<: *base
    profiles: [rosbridge-sim]
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_bringup rosbridge_sim.launch.py

  # --------------------------------------------------------------------------
  # Remote VLA Inference Service
  # --------------------------------------------------------------------------
  remote-inference:
    profiles: [remote-inference]
    build: *build-inference
    volumes: *inference-volumes
    environment:
      <<: *inference-env
    deploy:
      <<: *gpu-deploy

  # --------------------------------------------------------------------------
  # LeRobot Services
  # --------------------------------------------------------------------------
  lerobot:
    profiles: [lerobot]
    build:
      <<: *build-lerobot
      target: dev
    devices:
      - "${USB_DEVICE:-/dev/ttyUSB0}:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
      - "/dev/bus/usb:/dev/bus/usb"
    privileged: true
    volumes: *lerobot-volumes
    environment:
      <<: *lerobot-env
    group_add: *real-groups
    working_dir: /workspace/lerobot
    stdin_open: true
    tty: true
    command: /bin/bash

  lerobot-train:
    profiles: [lerobot-train]
    build:
      <<: *build-lerobot
      target: dev
    volumes: *lerobot-volumes
    environment:
      <<: *lerobot-env
    deploy:
      <<: *gpu-deploy
    working_dir: /workspace/lerobot
    command: >
      python -m lerobot.train
        --config configs/act_crane_x7.yaml

# ============================================================================
# Volumes
# ============================================================================

volumes:
  tailscale-state:

# ============================================================================
# Networks
# ============================================================================

networks:
  default:
    name: crane_x7
