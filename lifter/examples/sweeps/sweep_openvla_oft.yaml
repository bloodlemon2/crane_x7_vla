# ============================================================================
# W&B Sweep Configuration for OpenVLA-OFT
# ============================================================================
# ハイパーパラメータ自動探索の設定ファイル
#
# OpenVLA-OFT: L1回帰アクションヘッド + アクションチャンキング + FiLM + Proprio入力
#
# 使用方法:
#   slurm-submit sweep start examples/sweeps/sweep_openvla_oft.yaml \
#     --template examples/templates/openvla_oft_sweep.sh -n 10
#
# ============================================================================

# Sweep基本設定
method: bayes  # 探索方法: bayes, grid, random
metric:
  name: eval/loss
  goal: minimize

# エージェントが実行するコマンド
command:
  - ${env}
  - ${interpreter}
  - -m
  - crane_x7_vla.training.cli
  - train
  - openvla-oft
  - ${args_no_boolean_flags}

# 探索するハイパーパラメータ
parameters:
  # 学習率 (対数スケールで探索)
  learning_rate:
    distribution: log_uniform_values
    min: 1e-6
    max: 1e-3

  # バッチサイズ (離散値)
  batch_size:
    values: [1, 2, 4]

  # LoRAランク
  lora_rank:
    values: [8, 16, 32, 64]

  # LoRA alpha (通常はrankと同じか2倍)
  lora_alpha:
    values: [8, 16, 32, 64]

  # LoRAドロップアウト
  lora_dropout:
    distribution: uniform
    min: 0.0
    max: 0.2

  # 重み減衰 (対数スケール)
  weight_decay:
    distribution: log_uniform_values
    min: 1e-5
    max: 1e-1

  # ウォームアップステップ
  warmup_steps:
    values: [100, 500, 1000, 2000]

  # 勾配クリッピング
  max_grad_norm:
    distribution: uniform
    min: 0.5
    max: 2.0

  # 勾配累積ステップ (実効バッチサイズ = batch_size * gradient_accumulation_steps)
  gradient_accumulation_steps:
    values: [1, 2, 4, 8]

  # 画像オーグメンテーション
  image_aug:
    values: [true, false]

  # === OFT固有パラメータ ===

  # アクションホライズン (チャンキング)
  action_horizon:
    values: [4, 8, 16, 32]

  # FiLM (Feature-wise Linear Modulation) 有効化
  film_enabled:
    values: [true, false]

  # プロプリオセプティブ入力有効化
  proprio_enabled:
    values: [true, false]

  # マルチイメージ入力有効化
  multi_image_enabled:
    values: [true, false]

  # アクションヘッドのブロック数
  action_head_num_blocks:
    values: [1, 2, 3]

  # アクションヘッドのドロップアウト
  action_head_dropout:
    distribution: uniform
    min: 0.0
    max: 0.3

# 早期終了設定 (性能が悪いrunを早期に終了)
early_terminate:
  type: hyperband
  min_iter: 3
  eta: 3
  s: 2
