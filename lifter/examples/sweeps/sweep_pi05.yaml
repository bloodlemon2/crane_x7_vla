# ============================================================================
# W&B Sweep Configuration for Pi0.5
# ============================================================================
# ハイパーパラメータ自動探索の設定ファイル
#
# Pi0.5: Pi0 + adaRMSNorm + Discrete State入力
# Pi0よりmax_token_lenが大きい（200 vs 48）ため、バッチサイズを小さめに設定
#
# 使用方法:
#   slurm-submit sweep start examples/sweeps/sweep_pi05.yaml \
#     --template examples/templates/pi05_sweep.sh -n 10
#
# ============================================================================

# Sweep基本設定
method: bayes  # 探索方法: bayes, grid, random
metric:
  name: train/loss
  goal: minimize

# エージェントが実行するコマンド
command:
  - ${env}
  - ${interpreter}
  - -m
  - crane_x7_vla.training.cli
  - train
  - pi0.5
  - ${args_no_boolean_flags}

# 探索するハイパーパラメータ
# NOTE: 以下のパラメータは実験結果に基づいて調整済み (2025-12)
#   - freeze_vlm=True は勾配が不安定になるため除外
#   - gradient_accumulation_steps < 8 はメモリ不足でExceptionを起こす
#   - learning_rate < 1e-5 は収束が遅くHyperbandで早期終了される
#   - num_denoise_steps=5 は数値的に不安定
parameters:
  # 学習率 (対数スケールで探索)
  # 1e-5 ~ 5e-4 が安定した範囲
  learning_rate:
    distribution: log_uniform_values
    min: 1e-5
    max: 5e-4

  # バッチサイズ (Pi0.5はメモリ使用量が高いため小さめ)
  batch_size:
    values: [1]

  # 重み減衰 (対数スケール)
  weight_decay:
    distribution: log_uniform_values
    min: 1e-4
    max: 1e-2

  # ウォームアップステップ
  warmup_steps:
    values: [100, 500, 1000]

  # 勾配クリッピング
  max_grad_norm:
    distribution: uniform
    min: 0.5
    max: 2.0

  # 勾配累積ステップ (実効バッチサイズ = batch_size * gradient_accumulation_steps)
  # 8未満は除外（メモリ不足でException発生）
  gradient_accumulation_steps:
    values: [8, 16, 32]

  # Flow Matching デノイズステップ
  # 5は数値的に不安定なため除外
  num_denoise_steps:
    values: [10, 20, 50]

  # アクションホライズン
  action_horizon:
    values: [25, 50]

  # 正規化モード
  normalization_mode:
    values: ["quantile", "zscore"]

  # VLMを凍結するか
  # freeze_vlm=True はExpert Gemmaのみの学習で勾配が不安定になるため除外
  freeze_vlm:
    values: [false]

# 早期終了設定 (性能が悪いrunを早期に終了)
early_terminate:
  type: hyperband
  min_iter: 3
  eta: 3
  s: 2
